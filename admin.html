<!DOCTYPE html> 
<html lang="zh-Hant"> 
<head> 
    <meta charset="UTF-8"> 
    <meta name="viewport" content="width=device-width, initial-scale=1.0"> 
    <title>後台管理系統</title> 
    <script src="/socket.io/socket.io.js"></script> 
    <style> 
        body { 
            font-family: Arial, sans-serif; 
            background-color: #f4f4f4; 
            color: #333; 
            line-height: 1.6; 
            margin: 0;
            padding: 20px;
        } 
        .container { 
            max-width: 900px; 
            margin: 20px auto; 
            padding: 20px; 
            background: #fff; 
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1); 
            border-radius: 8px;
        } 
        h1 { 
            text-align: center; 
            color: #4CAF50; 
            margin-bottom: 20px;
        } 
        .admin-login-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            align-items: center;
        }
        .admin-login-section input[type="text"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .admin-login-section button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 8px 15px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s ease;
        }
        .admin-login-section button:hover {
            background-color: #0056b3;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
        } 
        th, td { 
            padding: 12px 15px; 
            border: 1px solid #ddd; 
            text-align: left; 
        } 
        th { 
            background-color: #4CAF50; 
            color: white; 
        } 
        tr:nth-child(even) { 
            background-color: #f2f2f2; 
        } 
        button { 
            background-color: #f44336; 
            color: white; 
            border: none; 
            padding: 8px 12px; 
            cursor: pointer; 
            border-radius: 4px; 
            transition: opacity 0.3s ease;
        } 
        button:hover { 
            opacity: 0.8; 
        } 
        .disabled-action {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }
        .disabled-action:hover {
            opacity: 0.6;
        }
    </style> 
</head> 
<body> 

    <div class="container"> 
        <h1>後台管理</h1> 

        <div class="admin-login-section">
            <label for="adminUsername">管理員名稱:</label>
            <input type="text" id="adminUsername" placeholder="輸入管理員名稱 (例如: admin)">
            <button id="setAdminNameButton">設定名稱</button>
        </div>
        
        <table> 
            <thead> 
                <tr> 
                    <th>房間名稱</th> 
                    <th>房主</th> 
                    <th>玩家人數</th> 
                    <th>玩家上限</th> 
                    <th>遊戲模式</th> 
                    <th>操作</th> 
                </tr> 
            </thead> 
            <tbody id="room-list"> 
                <tr><td colspan="6" style="text-align: center;">請先輸入管理員名稱以查看房間列表。</td></tr>
            </tbody> 
        </table> 
        
        <p id="status-message" style="text-align: center; margin-top: 20px;"></p> 
    </div> 

    <script> 
        document.addEventListener('DOMContentLoaded', () => { 
            const backendUrl = 'https://star-room-backend.onrender.com'; 
            const roomListTbody = document.getElementById('room-list'); 
            const statusMessage = document.getElementById('status-message'); 
            const adminUsernameInput = document.getElementById('adminUsername');
            const setAdminNameButton = document.getElementById('setAdminNameButton');

            let currentAdminUsername = ''; // 用於儲存已設定的管理員名稱

            // 輔助函數：將遊戲模式轉換為中文 
            function getGameModeText(mode) { 
                switch (mode) { 
                    case 'normal': 
                        return '正常遊戲模式'; 
                    case 'custom': 
                        return '特殊模式 (自訂義)'; 
                    default: 
                        return '未知'; 
                } 
            } 
            
            async function fetchRooms() { 
                if (!currentAdminUsername) {
                    statusMessage.textContent = '請先輸入管理員名稱。';
                    roomListTbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">請先輸入管理員名稱以查看房間列表。</td></tr>';
                    return;
                }

                try { 
                    statusMessage.textContent = '載入房間列表...'; 
                    const response = await fetch(`${backendUrl}/api/admin/rooms`); 
                    
                    if (!response.ok) { 
                        throw new Error(`HTTP error! status: ${response.status}`); 
                    } 
                    
                    const rooms = await response.json(); 
                    
                    if (rooms.length === 0) { 
                        statusMessage.textContent = '目前沒有任何房間。'; 
                        roomListTbody.innerHTML = ''; 
                    } else { 
                        statusMessage.textContent = ''; 
                        renderRooms(rooms); 
                    } 
                } catch (error) { 
                    statusMessage.textContent = `無法載入房間列表，請檢查伺服器。錯誤: ${error.message}`; 
                    console.error('Error fetching rooms:', error); 
                } 
            } 

            function renderRooms(rooms) { 
                roomListTbody.innerHTML = ''; 
                rooms.forEach(room => { 
                    const row = document.createElement('tr'); 
                    row.innerHTML = ` 
                        <td>${room.roomName}</td> 
                        <td>${room.owner || 'N/A'}</td> 
                        <td>${room.players.length}</td> 
                        <td>${room.maxPlayers}</td> 
                        <td>${getGameModeText(room.gameMode)}</td> 
                        <td><button class="delete-btn" data-room-name="${room.roomName}">刪除</button></td> 
                    `; 
                    roomListTbody.appendChild(row); 
                }); 

                // 綁定刪除按鈕事件
                document.querySelectorAll('.delete-btn').forEach(button => { 
                    button.addEventListener('click', async (event) => { 
                        const roomName = event.target.dataset.roomName; 
                        // 使用自定義的模態框代替 confirm
                        if (confirm(`確定要刪除房間 "${roomName}" 嗎？這將無法復原！`)) { 
                            await deleteRoom(roomName); 
                        } 
                    }); 
                }); 
            } 

            async function deleteRoom(roomName) { 
                if (!currentAdminUsername) {
                    alert('請先設定管理員名稱！');
                    return;
                }
                try { 
                    const response = await fetch(`${backendUrl}/api/delete-room`, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ roomName: roomName, username: currentAdminUsername }) // 使用已設定的管理員名稱
                    }); 

                    const data = await response.json(); 

                    if (data.success) { 
                        alert(data.message); 
                        fetchRooms(); // 重新載入房間列表 
                    } else { 
                        alert(`錯誤：${data.message}`); 
                    } 
                } catch (error) { 
                    alert('網路錯誤，請檢查伺服器是否運行。'); 
                    console.error('Error deleting room:', error); 
                } 
            } 

            // 設定管理員名稱的事件監聽器
            setAdminNameButton.addEventListener('click', () => {
                const enteredUsername = adminUsernameInput.value.trim();
                if (enteredUsername) {
                    currentAdminUsername = enteredUsername;
                    alert(`管理員名稱已設定為: ${currentAdminUsername}`);
                    fetchRooms(); // 設定後立即載入房間
                } else {
                    alert('請輸入有效的管理員名稱！');
                    currentAdminUsername = ''; // 清空，防止使用空名稱
                    fetchRooms(); // 再次提示輸入
                }
            });

            // 監聽 Socket.IO 的事件 
            const socket = io(); // 建立 Socket 連線 

            // 接收後端發送的房間更新事件 
            socket.on('roomUpdated', () => { 
                console.log('收到房間更新通知，重新載入列表。'); 
                fetchRooms(); 
            }); 

            socket.on('roomCreated', (roomName) => { 
                console.log(`收到新房間建立通知: ${roomName}`); 
                fetchRooms(); 
            }); 

            socket.on('roomDeleted', (roomName) => { 
                console.log(`收到房間刪除通知: ${roomName}`); 
                fetchRooms(); 
            }); 
        }); 
    </script> 
</body> 
</html>
